name: OpenTaco (Infrastruktura)

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize, closed ]
    # Optymalizacja Monorepo: Akcja uruchomi siÄ™ TYLKO, gdy zmienisz kod w folderze infra
    paths:
      - '01-terraform-infra/**'
      - 'digger.yml'
  issue_comment:
    types: [ created ]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  id-token: write      # ABSOLUTNIE KRYTYCZNE: Uprawnienie do wygenerowania tokenu JWT dla AWS OIDC

jobs:
  digger-job:
    name: OpenTaco / Terragrunt Orkiestracja
    runs-on: ubuntu-latest
    
    # Warunek uruchomienia:
    # 1. To jest Pull Request (wtedy Å›cieÅ¼ki z bloku 'on' decydujÄ… o starcie)
    # LUB
    # 2. To jest komentarz w PR i zawiera sÅ‚owo kluczowe "digger" lub "opentaco"
    if: >-
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && (contains(github.event.comment.body, 'digger') || contains(github.event.comment.body, 'opentaco')))

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Wymagane dla analizy rÃ³Å¼nic w Terragruncie

      - name: ğŸ” Konfiguracja AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::438950223046:role/Twoja-Rola-GitHub-OIDC # <--- PODMIEÅƒ ARN
          aws-region: eu-central-1 # <--- PODMIEÅƒ REGION

      - name: âš™ï¸ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu-version: 1.6.0 # DobrÄ… praktykÄ… jest usztywnienie wersji na produkcji

      - name: âš™ï¸ Setup Terragrunt
        run: |
          TG_VERSION="v0.55.0" # Zgodnie z Twoimi preferencjami
          curl -sLo terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VERSION}/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/

      - name: ğŸš€ Run OpenTaco (Digger)
        uses: diggerhq/digger@vLatest
        with:
          # WyÅ‚Ä…czamy wbudowane instalatory, poniewaÅ¼ przygotowaliÅ›my wÅ‚asne (Tofu+Terragrunt i OIDC)
          setup-aws: false
          setup-terraform: false
          no-backend: true # Wymusza tryb Standalone (Community) bez Å‚Ä…czenia z chmurÄ… Diggera
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}