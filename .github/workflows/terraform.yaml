# name: "Terraform CI/CD"

# on:
#   pull_request:
#     branches: ["main"]
#     paths:
#       - '01-terraform-infra/**'
#   push:
#     branches: ["main"]
#     paths:
#       - '01-terraform-infra/**'

# permissions:
#   contents: read
#   pull-requests: write

# jobs:
#   filter:
#     runs-on: ubuntu-latest
#     outputs:
#       workspaces: ${{ steps.filter.outputs.changes }}
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - name: Paths Changes Filter
#         id: filter
#         uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # 3.0.2
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           filters: .github/utils/file-filters.yaml

#   terraform-plan:
#     runs-on: ubuntu-latest
#     if: github.event_name == 'pull_request' && needs.filter.outputs.workspaces != '[]'
#     needs: filter
#     strategy:
#       fail-fast: false
#       matrix:
#         workspace: ${{ fromJSON(needs.filter.outputs.workspaces) }}
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - uses: hashicorp/setup-terraform@97f030cf6dc0b4f5e0da352c7bca9cca34579800 # 3.1.0
#         with:
#           cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

#       - name: Resolve workspace path
#         id: path
#         run: |
#           WS="${{ matrix.workspace }}"
#           if [[ "$WS" == global/* ]]; then
#             echo "dir=01-terraform-infra/${WS}" >> "$GITHUB_OUTPUT"
#           else
#             echo "dir=01-terraform-infra/envs/${WS}" >> "$GITHUB_OUTPUT"
#           fi

#       - name: Terraform Init
#         run: terraform -chdir=${{ steps.path.outputs.dir }} init

#       - name: Terraform Plan
#         id: plan
#         run: terraform -chdir=${{ steps.path.outputs.dir }} plan -no-color
#         continue-on-error: true

#       - name: Comment PR with Plan
#         uses: actions/github-script@v7
#         env:
#           PLAN: ${{ steps.plan.outputs.stdout }}
#           WORKSPACE: ${{ matrix.workspace }}
#         with:
#           github-token: ${{ secrets.GITHUB_TOKEN }}
#           script: |
#             const output = `#### Terraform Plan: \`${process.env.WORKSPACE}\` \`${{ steps.plan.outcome }}\`

#             <details><summary>Show Plan Output</summary>

#             \`\`\`terraform\n
#             ${process.env.PLAN}
#             \`\`\`

#             </details>

#             *Pusher: @${{ github.actor }}*`;

#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body: output
#             })

#       - name: Check Plan Status
#         if: steps.plan.outcome == 'failure'
#         run: exit 1

#   # -----------------------------------------------------------
#   # APPLY: global/ecr (environment-independent, runs first)
#   # -----------------------------------------------------------
#   terraform-apply-global:
#     needs: filter
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(needs.filter.outputs.workspaces, 'global/ecr')
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - uses: hashicorp/setup-terraform@97f030cf6dc0b4f5e0da352c7bca9cca34579800 # 3.1.0
#         with:
#           cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

#       - name: Init & Apply ECR
#         run: |
#           terraform -chdir=01-terraform-infra/global/ecr init
#           terraform -chdir=01-terraform-infra/global/ecr apply -auto-approve

#   # -----------------------------------------------------------
#   # APPLY: dev (auto-deploy, sequential: network → compute → bootstrap)
#   # -----------------------------------------------------------
#   terraform-apply-dev:
#     needs: [filter, terraform-apply-global]
#     if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && !failure() && !cancelled()
#     runs-on: ubuntu-latest
#     environment: dev
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - uses: hashicorp/setup-terraform@97f030cf6dc0b4f5e0da352c7bca9cca34579800 # 3.1.0
#         with:
#           cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

#       - name: Init & Apply Network
#         if: contains(needs.filter.outputs.workspaces, 'dev/00-network')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/dev/00-network init
#           terraform -chdir=01-terraform-infra/envs/dev/00-network apply -auto-approve

#       - name: Init & Apply Compute
#         if: contains(needs.filter.outputs.workspaces, 'dev/20-compute')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/dev/20-compute init
#           terraform -chdir=01-terraform-infra/envs/dev/20-compute apply -auto-approve

#       - name: Init & Apply Bootstrap
#         if: contains(needs.filter.outputs.workspaces, 'dev/30-bootstrap')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/dev/30-bootstrap init
#           terraform -chdir=01-terraform-infra/envs/dev/30-bootstrap apply -auto-approve

#   # -----------------------------------------------------------
#   # APPLY: stg (requires approval, sequential: network → compute → bootstrap)
#   # -----------------------------------------------------------
#   terraform-apply-stg:
#     needs: [filter, terraform-apply-dev]
#     if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && !failure() && !cancelled()
#     runs-on: ubuntu-latest
#     environment: stg
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - uses: hashicorp/setup-terraform@97f030cf6dc0b4f5e0da352c7bca9cca34579800 # 3.1.0
#         with:
#           cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

#       - name: Init & Apply Network
#         if: contains(needs.filter.outputs.workspaces, 'stg/00-network')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/stg/00-network init
#           terraform -chdir=01-terraform-infra/envs/stg/00-network apply -auto-approve

#       - name: Init & Apply Compute
#         if: contains(needs.filter.outputs.workspaces, 'stg/20-compute')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/stg/20-compute init
#           terraform -chdir=01-terraform-infra/envs/stg/20-compute apply -auto-approve

#       - name: Init & Apply Bootstrap
#         if: contains(needs.filter.outputs.workspaces, 'stg/30-bootstrap')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/stg/30-bootstrap init
#           terraform -chdir=01-terraform-infra/envs/stg/30-bootstrap apply -auto-approve

#   # -----------------------------------------------------------
#   # APPLY: prod (requires approval, sequential: network → compute → bootstrap)
#   # -----------------------------------------------------------
#   terraform-apply-prod:
#     needs: [filter, terraform-apply-stg]
#     if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && !failure() && !cancelled()
#     runs-on: ubuntu-latest
#     environment: prod
#     steps:
#       - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
#       - uses: hashicorp/setup-terraform@97f030cf6dc0b4f5e0da352c7bca9cca34579800 # 3.1.0
#         with:
#           cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

#       - name: Init & Apply Network
#         if: contains(needs.filter.outputs.workspaces, 'prod/00-network')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/prod/00-network init
#           terraform -chdir=01-terraform-infra/envs/prod/00-network apply -auto-approve

#       - name: Init & Apply Compute
#         if: contains(needs.filter.outputs.workspaces, 'prod/20-compute')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/prod/20-compute init
#           terraform -chdir=01-terraform-infra/envs/prod/20-compute apply -auto-approve

#       - name: Init & Apply Bootstrap
#         if: contains(needs.filter.outputs.workspaces, 'prod/30-bootstrap')
#         run: |
#           terraform -chdir=01-terraform-infra/envs/prod/30-bootstrap init
#           terraform -chdir=01-terraform-infra/envs/prod/30-bootstrap apply -auto-approve
